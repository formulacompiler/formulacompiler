<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <title>Repeating Sections with SEJ - arrenbrecht.ch</title>
    <style type="text/css" media="screen">
        @import "../style.css";
	
    </style>
    <link rel="stylesheet" type="text/css" media="print" href="../printstyle.css" />
</head>
<body>
    <div class="all">
        <div class="nav">
            <p class="nav">
<a href="http://www.arrenbrecht.ch/">arrenbrecht.ch</a> &gt;
<a href="../index.htm">SEJ</a> &gt;
<a href="index.htm">Tutorial</a> &gt;

			</p>
        </div>
        <div class="title">
            <h1>
                Repeating Sections with SEJ</h1>
        </div>
        
        
        <div class="content">
        
<p>SEJ allows you to define <em>repeating sections</em> in a spreadsheet. Such sections are different from ordinary ranges in Excel in that the width or height of the section varies with each use of the computation.</p>
<p>For example, consider a hypothetical customer rating computation. We want users to be able to define a spreadsheet that computes the rating that we run for each customer in turn. For each customer, we feed the totals of all his orders of the last three months to the computation. One particular customer may have placed 5 orders in the last three months, another one 200.</p>
<p>Let me show you a very simple spreadsheet that computes such a customer rating. Note that in the depicted spreadsheet</p>
<ul compact class="compact">
<li>the colored area is a named range whose name is given just below the sheet, and</li>
<li>the blue names in parentheses are cell names.</li>
</ul>
<p>[xc:testdata/sej/tutorials/CustomerRating.xls]</p>
<p>The row range <tt>3:7</tt> will be our repeating section with variable height. Cell <tt>B10</tt>, the <em>Total</em>, sums the five rows 3..7. For every actual computation, SEJ will shrink or extend the range within the sum in <tt>B10</tt> to match the number of order totals we actually passed in.</p>

<h2>Spreadsheet Rules</h2>
<p>The fact that my original spreadsheet has exactly five order total rows is irrelevant to SEJ. What matters is that</p>
<ul compact class="compact">
<li>when we define the repeating section over the rows 3..7,</li>
<li>the sum in <tt>B10</tt> covers the entire height of the variable section, and</li>
<li>the formula in <tt>B10</tt> uses the range function <tt>SUM</tt>, rather than <tt>B3+...+B7</tt>.</li>
</ul>
<p>Generally speaking, if you reference cells of a repeating section from outside the section, you'll have to use a spreadsheet function that takes a <em>range</em> as an argument. This range must cover the entire variable extent of the section (height or width).</p>
<p>So we could just as well have used ten, or only two example rows. (In fact, we can get away with just one example row. I don't recommend this, though, because you might then forget to use <tt>SUM</tt> over the rows.)</p>
<p>In any case, SEJ uses <b>only the first row</b> as a template for making the <em>n</em> rows later on, at runtime. This will be important later when I show you a more complex spreadsheet.</p>

<h2>Hooking It Up</h2>
<p>Let's hook up the above spreadsheet with the customer rating application. First of all, we need an interface to the customer data. This interface must let SEJ query the order totals. A simple approach would be to just return an array of order totals. SEJ needs a little more structure than this, though.</p>
<p>When you define a repeating section with SEJ, the section is treated like an embedded sub-sheet within the main sheet. Like a master/detail form really. This sub-sheet works just like the main sheet, so it must have an input interface to get values from. (As you'll see later, one advantage of having a proper interface for section elements is it becomes very straightforward to add new input values like the order date.)</p>
<p>Here's the interface for the orders sub-sheet we are going to use:</p>
<p>[jc:sej.tutorials.CustomerRatingWithOrders:---- OrderData]</p>
<p>The main customer interface must therefore let SEJ query the set of orders it should process for this customer. The simplest way is to use an array:</p>
<p>[jc:sej.tutorials.CustomerRatingWithOrders:---- CustomerData; omit -- CustomerDataAlternatives]</p>
<p>You can also use an <tt>Iterable</tt> or an <tt>Iterator</tt>, or one of their descendants. Like so:</p>
<p>[jc:sej.tutorials.CustomerRatingWithOrders:-- CustomerDataAlternatives]</p>
<p>We now need to tell SEJ that the order totals range of cells in the spreadsheet should be considered a vertically repeating section, which gets its data from the call shown above. In addition, we must tell SEJ the precise input interface to use for the orders, namely <tt>OrderData</tt>. Here's how to do this (given that the name <em>OrdersForLastThreeMonths</em> is defined in the spreadsheet as <tt>B3:B7</tt>):</p>
<p>[jc:sej.tutorials.CustomerRatingWithOrders:---- bindOrders; omit -- omit]</p>
<p>As I said above, a repeating section is like a sub-sheet within the main-sheet. Thus, the return value of this method is again a <tt>Section</tt>, just like the original <tt>binder</tt> for the main sheet. We use it to bind the cells in the first template row of the section to input methods on the order interface. Like so (given that the name <em>OrderTotal</em> is defined in the spreadsheet as <tt>B3</tt>):</p>
<p>[jc:sej.tutorials.CustomerRatingWithOrders:---- bindOrderValues]</p>
<p>Binding the outputs is straightforward, as we are only binding global values, not values within the repeating section:</p>
<p>[jc:sej.tutorials.CustomerRatingWithOrders:---- bindRating]</p>
<p>We do, however, have to make our output interface <a href="caching.htm">resettable</a>. This is because SEJ always caches the elements of a repeatable section internally. Here it is, then:</p>
<p>[jc:sej.tutorials.CustomerRatingWithOrders:---- CustomerRating]</p>

<h5>Note</h5>
<p>Given the return type <tt>OrderData[]</tt>, SEJ could infer the input interface for the section by itself. Unfortunately, this is not possible when the return type is a <tt>Collection</tt> or an <tt>Iterator</tt>. Even <tt>Collection&lt;OrderData&gt;</tt> does not help because the generics annotations are erased at runtime. SEJ therefore generally mandates that you pass it the interface type to use.</p>

<h2>Intermediate Values In A Repeating Section</h2>
<p>Let's extend the order totals example a bit. In the sum of the order totals, we want to give less weight to older values. To do this, we add the order date to the order interface:</p>
<p>[jc:sej.tutorials.CustomerRatingWithOrdersComplex:---- OrderData]</p>
<p>We now want our spreadsheet to compute the age of an order in days, and from that to compute the weight to give to the order's total. To do this, we compute the difference between the current date and the order date, and then linearly reduce the weight of olders orders towards 0 at the age of 90 days. The prototype row 3 shows this:</p>
<p>[xc:testdata/sej/tutorials/CustomerRatingComplex.xls]</p>
<p>To consider:</p>
<ul class="spaced">
<li>The order date is an input value. But to provide meaningful sample values for it, I have used a formula that computes them relative to the current date.</li>
<li>We now have intermediate values within the repeating section. Columns B and C are inputs, but columns D, E, F are computed within the spreadsheet.</li>
<li>The final aggregation in <tt>B10</tt> now sums the computed section values in <tt>F3:F7</tt>.</li>
<li>The computed row value in column D references a cell outside of the repeating section, namely the current date in <tt>B11</tt>.</li>
</ul>
<p>SEJ handles all of this correctly. You do, however, have to follow a few rules:</p>
<ul class="spaced">
<li>When referencing within the section, only reference within the same row. You cannot reference a value from a sibling row. In particular, you cannot do running totals.</li>
<li>As stated above, SEJ only looks at the <b>first row</b> of the section (row 3 here), which it then uses as a template for all others. You must yourself take care that your other example rows (rows 4 through 7 here) have formulas of a similiar structure as the template row.</li>
</ul>
<p>The only remaining thing is to bind the order date in a fashion similar to the order total (assuming the name <em>OrderDate</em> is defined in the spreadsheet as <tt>C3</tt>):</p>
<p>[jc:sej.tutorials.CustomerRatingWithOrdersComplex:---- bindOrderValues]</p>        </div>
        <div class="footer">
<p>Copyright &copy; 2006 Peter Arrenbrecht. All rights reserved.</p>        </div>
    </div>
</body>
</html>